<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title>Mediasoup Mic Test</title>
	<!-- socket.io (—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç) -->
	<script src="/socket.io/socket.io.js"></script>

	<!-- mediasoup-client —Å CDN (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é jsDelivr, —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ) -->
	<script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3/lib/index.min.js"></script>
	<!-- –∏–ª–∏ —Å–≤–µ–∂–∞–π—à–∞—è –≤–µ—Ä—Å–∏—è –Ω–∞ –º–æ–º–µ–Ω—Ç 2026 -->
	<!-- <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3.18.6/lib/index.min.js"></script> -->
</head>
<body>
<button id="start">Start mic ‚Üí produce audio</button>

<script>
    const { Device } = mediasoupClient;   // ‚Üê –≤–æ—Ç —Ç–∞–∫

    let device;
    let transport;
    let producer;

    // socket.io –∫–ª–∏–µ–Ω—Ç ‚Äî –±–µ—Ä—ë–º –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø—É—Ç–∏
    const socket = io();   // ‚Üê —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞ —Ç–æ–º –∂–µ origin

    document.getElementById("start").onclick = async () => {
        console.log("‚ñ∂Ô∏è start clicked");

        let stream;
        try {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            console.log("üéô got stream");
        } catch (e) {
            console.error("‚ùå mic error", e);
            return;
        }

        const track = stream.getAudioTracks()[0];
        if (!track) {
            console.error("‚ùå no audio track");
            return;
        }
        console.log("üéß track ready", track);

        // 1. –ü–æ–ª—É—á–∞–µ–º rtpCapabilities
        const rtpCapabilities = await new Promise(resolve => {
            socket.emit("getRtpCapabilities", null, resolve);
        });
        console.log("üì¶ rtpCapabilities received");

        // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º device

        // –¥–∞–ª—å—à–µ –∫–∞–∫ –±—ã–ª–æ:
        device = new Device();
        await device.load({ routerRtpCapabilities: rtpCapabilities });
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ—Ç–ª–∞–¥–∫–∏)
        console.log("üì° device loaded, canProduce audio ‚Üí", device.canProduce("audio"));

        // 3. –°–æ–∑–¥–∞—ë–º send-—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
        const params = await new Promise(resolve => {
            socket.emit("createTransport", null, resolve);
        });
        console.log("üöö transport params", params);

        transport = device.createSendTransport(params);

        transport.on("connect", ({ dtlsParameters }, callback, errback) => {
            console.log("üîê transport connect event");
            socket.emit("connectTransport", { dtlsParameters }, response => {
                if (response?.error) {
                    errback(response.error);
                    return;
                }
                callback();
            });
        });

        transport.on("produce", ({ kind, rtpParameters }, callback, errback) => {
            console.log("üì§ produce event", kind);
            socket.emit("produce", { kind, rtpParameters }, response => {
                if (response?.error) {
                    errback(response.error);
                    return;
                }
                callback({ id: response.id });
            });
        });

        transport.on("connectionstatechange", state => {
            console.log("transport connectionstatechange ‚Üí", state);
        });

        // 4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏–º –∞—É–¥–∏–æ
        try {
            producer = await transport.produce({ track });
            console.log("‚úÖ producer created ‚Üí", producer.id);
        } catch (err) {
            console.error("‚ùå produce failed", err);
        }
    };
</script>
</body>
</html>