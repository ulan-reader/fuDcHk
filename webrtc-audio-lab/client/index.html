<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Mediasoup Mic Test</title>
</head>
<body>
<button id="start">Start mic ‚Üí produce audio</button>


<script type="module">
  import * as mediasoupClient from 'mediasoup-client';
  import { io } from 'socket.io-client';

  const socket = io('http://localhost:3000');

  let device;
  let transport;
  let producer;

  document.getElementById('start').onclick = async () => {
    console.log('‚ñ∂Ô∏è start clicked');

    let stream;
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      console.log('üéô got stream');
    } catch (e) {
      console.error('‚ùå mic error', e);
      return;
    }

    const track = stream.getAudioTracks()[0];
    if (!track) {
      console.error('‚ùå no audio track');
      return;
    }
    console.log('üéß track ready');

    // 1. –ü–æ–ª—É—á–∏—Ç—å rtpCapabilities —Å —Å–µ—Ä–≤–µ—Ä–∞
    const rtpCapabilities = await new Promise(resolve => {
      socket.emit('getRtpCapabilities', null, resolve);
    });
    console.log('üì¶ rtpCapabilities received');

    // 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å device
    device = new mediasoupClient.Device();
    await device.load({ routerRtpCapabilities: rtpCapabilities });
    console.log('üì° device loaded, canProduce audio ‚Üí', device.canProduce('audio'));

    if (!device.canProduce('audio')) {
      console.error('‚ùå cannot produce audio');
      return;
    }

    // 3. –°–æ–∑–¥–∞—Ç—å send transport –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    const transportParams = await new Promise(resolve => {
      socket.emit('createTransport', null, resolve);
    });
    console.log('üöö transport params received', transportParams);

    transport = device.createSendTransport(transportParams);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è "connect" (DTLS handshake)
    transport.on('connect', ({ dtlsParameters }, callback, errback) => {
      console.log('üîê transport connect event');
      socket.emit('connectTransport', { dtlsParameters }, response => {
        if (response?.error) {
          errback(response.error);
          return;
        }
        callback();
      });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è "produce" (–∫–æ–≥–¥–∞ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç —Å–æ–∑–¥–∞—Ç—å producer)
    transport.on('produce', ({ kind, rtpParameters }, callback, errback) => {
      console.log('üì§ produce event triggered', kind);
      socket.emit('produce', { kind, rtpParameters }, response => {
        if (response?.error) {
          errback(response.error);
          return;
        }
        callback({ id: response.id });
      });
    });

    transport.on('connectionstatechange', state => {
      console.log('transport connectionstatechange ‚Üí', state);
    });

    // 4. –°–æ–∑–¥–∞—Ç—å producer (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–µ–∫ –≤ SFU)
    try {
      producer = await transport.produce({
        track,
        // encodings: [{ maxBitrate: 64000 }], // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è opus
        codecOptions: {
          opusStereo: 1,
          opusDtx: 1
        }
      });
      console.log('‚úÖ producer created ‚Üí ID:', producer.id);
    } catch (err) {
      console.error('‚ùå produce failed', err);
    }
  };
</script>


</body>
</html>